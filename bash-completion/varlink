_varlink_module()
{
        COMPREPLY=()
        local cur="${COMP_WORDS[COMP_CWORD]}"

        # Find known verb
        local verbs=(
                call
                error
                format
                help
                list
                resolve
        )
        local i
        local verb=
        for ((i = 1; i < ${#COMP_WORDS[@]}; i++)); do
                for ((j = 0; j < ${#verbs[@]}; j++)); do
                        if [[ ${COMP_WORDS[i]} == ${verbs[j]} ]]; then
                                verb=${COMP_WORDS[i]}
                                break
                        fi
                done
        done

        case $verb in
                'call')
                        case $cur in
                                -*)
                                        compopt -o nospace
                                        COMPREPLY=( $(compgen -W "--address= --help" -- $cur) )
                                        return 0
                                        ;;

                                *)
                                        compopt -o nospace
                                        COMPREPLY=( $(compgen -W "$(varlink list interfaces)" -- $cur) )
                                        return 0
                                        ;;
                        esac
                        return 0
                        ;;

                'error')
                        case $cur in
                                -*)
                                        COMPREPLY=( $(compgen -W "--help" -- $cur) )
                                        return 0
                                        ;;

                                *)
                                        COMPREPLY=( $(compgen -W "$(varlink error)" -- $cur) )
                                        return 0
                                        ;;
                        esac
                        return 0
                        ;;

                'format')
                        compopt -o filenames
                        COMPREPLY=( $(compgen -f -- $cur) )
                        return 0
                        ;;

                'help')
                        case $cur in
                                -*)
                                        compopt -o nospace
                                        COMPREPLY=( $(compgen -W "--address= --help" -- $cur) )
                                        return 0
                                        ;;

                                *)
                                        return 0
                                        ;;
                        esac
                        return 0
                        ;;

                'list')
                        case $cur in
                                -*)
                                        COMPREPLY=( $(compgen -W "--help" -- $cur) )
                                        return 0
                                        ;;

                                *)
                                        COMPREPLY=( $(compgen -W "interfaces" -- $cur) )
                                        return 0
                                        ;;
                        esac
                        return 0;
                        ;;

                'resolve')
                        case $cur in
                                -*)
                                        COMPREPLY=( $(compgen -W "--help" -- $cur) )
                                        return 0
                                        ;;

                                *)
                                        COMPREPLY=( $(compgen -W "$(varlink list interfaces)" -- $cur) )
                                        return 0
                                        ;;
                        esac
                        return 0
                        ;;

                # No verb found, offer one and global options
                '')
                        case $cur in
                                -*)
                                        compopt -o nospace
                                        COMPREPLY=( $(compgen -W "--resolver= --version --help" -- $cur) )
                                        return 0
                                        ;;

                                *)
                                        COMPREPLY=( $(compgen -W "${verbs[*]}" -- $cur) )
                                        return 0
                                        ;;
                        esac
                        return 0
                        ;;
        esac
        return 0
}

complete -F _varlink_module varlink
